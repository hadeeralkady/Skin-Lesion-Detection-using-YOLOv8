"""
Script: convert_masks_to_yolo_labels.py
Author: Hadeer Elkady

Summary:
This script converts skin lesion segmentation masks (from ISIC dataset) 
into YOLO-format labels for object detection training.

For each image:
1. Finds the corresponding segmentation mask.
2. Determines the bounding box around the white pixels (lesion area).
3. Converts bounding box coordinates to YOLO normalized format (0-1).
4. Saves the coordinates as a .txt file in the labels folder.
"""

import os
import cv2
import numpy as np

# =========================
# --- Folder paths ---
# =========================
images_folder = Project\ISIC2018_Task1-2_Training"   # Images folder
masks_folder  = Project\ISIC2018_Task1_Training_segmentation"  # Masks folder
labels_folder = Project\labels"  # Folder to save YOLO labels

# Create labels folder if it does not exist
os.makedirs(labels_folder, exist_ok=True)

# =========================
# --- Read and process images ---
# =========================
for image_name in os.listdir(images_folder):
    
    # Skip non-image files
    if not image_name.endswith((".jpg", ".png")):
        continue

    # Corresponding mask filename (image name + "_segmentation.png")
    mask_name = os.path.splitext(image_name)[0] + "_segmentation.png"
    mask_path = os.path.join(masks_folder, mask_name)
    
    # Skip if mask does not exist
    if not os.path.exists(mask_path):
        print(f"Mask for {image_name} not found, skipping.")
        continue

    # Read mask as grayscale
    mask = cv2.imread(mask_path, cv2.IMREAD_GRAYSCALE)

    # Find white pixels (lesion region)
    ys, xs = np.where(mask > 0)
    
    # Skip if mask is empty
    if len(xs) == 0 or len(ys) == 0:
        print(f"No white pixels in mask for {image_name}, skipping.")
        continue

    # Compute bounding box around the lesion
    xmin, xmax = xs.min(), xs.max()
    ymin, ymax = ys.min(), ys.max()

    # Read image to get dimensions
    img_path = os.path.join(images_folder, image_name)
    img = cv2.imread(img_path)
    img_h, img_w = img.shape[:2]

    # Convert bounding box to YOLO normalized format (0-1)
    x_center = ((xmin + xmax) / 2) / img_w
    y_center = ((ymin + ymax) / 2) / img_h
    width    = (xmax - xmin) / img_w
    height   = (ymax - ymin) / img_h

    # Write YOLO label file
    label_file = os.path.join(labels_folder, os.path.splitext(image_name)[0] + ".txt")
    with open(label_file, "w") as f:
        f.write(f"0 {x_center:.6f} {y_center:.6f} {width:.6f} {height:.6f}\n")

    print(f"Processed {image_name}")
